<template>
  <v-contextmenu-group>
    <li class="header">
      {{
        $tc(
          "{count} numéro sélectionné|{count} numéros sélectionnés",
          selectedIssues.length
        )
      }}
    </li>
    <b-alert
      v-if="!editingCopies.length"
      class="text-center m-0"
      show
      variant="danger"
      v-html="
        $t(
          'Vous allez retirer tous les exemplaires<br />des numéros sélectionnés'
        )
      "
    />
    <b-alert
      v-if="copies.length && !isSingleIssueSelected"
      class="text-center m-0"
      show
      variant="warning"
      v-html="
        $t(
          'Vous possédez certains numéros sélectionnés<br />en plusieurs exemplaires.<br />Seul le premier exemplaire sera modifié.'
        )
      "
    />
    <b-alert
      v-if="!selectedIssues.length"
      class="text-center m-0"
      show
      variant="warning"
      v-html="
        $t(
          'Sélectionnez un ou plusieurs numéros dans la liste<br />pour les ajouter, modifier ou supprimer de votre collection.'
        )
      "
    />
    <template v-else>
      <b-tabs
        v-model="currentCopyIndex"
        nav-class="copies-tabs"
        @changed="
          (newTabs) => {
            currentCopyIndex = newTabs.length - 1;
          }
        "
      >
        <b-tab
          v-for="(copy, copyIndex) in editingCopies"
          :key="`copy-${copyIndex}`"
        >
          <template #title>
            {{ $t("Exemplaire") }} {{ copyIndex + 1 }}
            <b-icon-trash
              @click.stop.prevent="editingCopies.splice(copyIndex, 1)"
            />
          </template>
          <v-contextmenu-group :title="$t('Etat')">
            <v-contextmenu-item
              v-for="(text, id) in conditionStates"
              :key="`condition-${id}`"
              :hide-on-click="false"
              :class="{ clickable: true, selected: copy.condition === id }"
              @click="copy.condition = id"
            >
              <Condition :value="id" />&nbsp;{{ text }}
            </v-contextmenu-item>
            <v-contextmenu-divider />
          </v-contextmenu-group>
          <v-contextmenu-group :title="$t('Date d\'achat')">
            <template
              v-for="(purchaseStateText, purchaseStateId) in purchaseStates"
              :key="`copy-${copyIndex}-purchase-state-${purchaseStateId}`"
            >
              <v-contextmenu-item
                v-if="purchaseStateId !== 'link'"
                :hide-on-click="false"
                :class="{
                  clickable: true,
                  selected: copy.purchaseId === purchaseStateId,
                  'purchase-state': true,
                  'v-context__sub': purchaseStateId === 'link',
                  [purchaseStateId]: true,
                }"
                @click="copy.purchaseId = purchaseStateId"
              >
                <b-icon-calendar-x v-if="purchaseStateId === 'unlink'" />
                {{ purchaseStateText }}
              </v-contextmenu-item>
              <v-contextmenu-submenu
                v-else
                :title="$t(`Date d'achat`)"
                @mouseleave.prevent="() => {}"
              >
                <template #title>
                  <b-icon-calendar v-if="purchaseStateId === 'link'" />
                  {{ purchaseStateText }}
                </template>
                <v-contextmenu-group :title="$t('Date d\'achat')">
                  <v-contextmenu-item
                    v-if="!copy.newPurchaseContext"
                    :hide-on-click="false"
                    class="clickable"
                    @click.stop="
                      copy.newPurchaseContext = !copy.newPurchaseContext;
                      copy.newPurchaseDate = today;
                    "
                  >
                    <b>{{ $t("Nouvelle date d'achat...") }}</b>
                  </v-contextmenu-item>
                  <v-contextmenu-item
                    v-else
                    class="purchase-date"
                    @click.stop="() => {}"
                  >
                    <b-form-input
                      v-model="copy.newPurchaseDate"
                      type="text"
                      lazy-formatter
                      :formatter="formatDate"
                      pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}"
                      required
                      class="form-control date px-0"
                      maxlength="10"
                      :placeholder="$t(`Date d'achat`)"
                      @click.stop="() => {}"
                    />
                    <input
                      v-model="copy.newPurchaseDescription"
                      required
                      type="text"
                      class="form-control text-center"
                      maxlength="30"
                      :placeholder="$t('Description')"
                      @click.stop="() => {}"
                    />
                    <b-button
                      variant="success"
                      class="btn-sm"
                      @click.stop="
                        $emit('create-purchase', {
                          date: copy.newPurchaseDate,
                          description: copy.newPurchaseDescription,
                        });
                        copy.newPurchaseDescription = '';
                        copy.newPurchaseDate = today;
                        copy.newPurchaseContext = false;
                      "
                    >
                      <b-icon-check icon="check" />
                    </b-button>
                    <b-button
                      variant="warning"
                      class="btn-sm"
                      @click.stop="copy.newPurchaseContext = false"
                    >
                      <b-icon-x icon="x" />
                    </b-button>
                  </v-contextmenu-item>
                  <v-contextmenu-item
                    v-for="{ id: purchaseId, date, description } in purchases"
                    :key="`copy-${copyIndex}-purchase-${purchaseId}`"
                    :hide-on-click="false"
                    :class="{
                      clickable: true,
                      selected: copy.purchaseId === purchaseId,
                      'purchase-date': true,
                    }"
                    @click.stop="copy.purchaseId = purchaseId"
                  >
                    <small class="date">{{ date }}</small>
                    <div class="mx-2">
                      {{ description }}
                    </div>
                    <b-button
                      class="delete-purchase btn-sm"
                      :title="$t('Supprimer')"
                      @click="
                        $emit('delete-purchase', {
                          id: purchaseId,
                        })
                      "
                    >
                      <b-icon-trash />
                    </b-button>
                  </v-contextmenu-item>
                </v-contextmenu-group>
              </v-contextmenu-submenu>
            </template>
          </v-contextmenu-group>
        </b-tab>
        <template v-if="!hasMaxCopies" #tabs-end>
          <b-nav-item
            v-if="isSingleIssueSelected || hasNoCopies"
            class="p-0"
            role="presentation"
            @click="editingCopies.push({ ...defaultState })"
          >
            {{ $t("Ajouter un exemplaire") }}
          </b-nav-item>
          <b-nav-item
            v-else
            class="p-0 disabled text-secondary"
            role="presentation"
            :title="
              $t(
                `Vous pouvez seulement ajouter un exemplaire lorsqu'un seul numéro est sélectionné`
              )
            "
          >
            {{ $t("Ajouter un exemplaire") }}
          </b-nav-item>
        </template>
      </b-tabs>
      <li class="footer clickable" @click="updateSelectedIssues">
        {{ $t("Enregistrer les changements") }}
      </li>
    </template>
  </v-contextmenu-group>
</template>

<script setup>
import {
  BIconCalendar,
  BIconCalendarX,
  BIconCheck,
  BIconTrash,
  BIconX,
} from "bootstrap-icons-vue";
import { BAlert, BNavItem, BTab, BTabs } from "bootstrap-vue-3";
import { watch } from "vue";
import { useI18n } from "vue-i18n";

import { condition } from "../composables/condition";
import { collection } from "../stores/collection";
import { l10n } from "../stores/l10n";
import Condition from "./Condition";

const { copies, publicationcode, selectedIssues } = defineProps({
    publicationCode: {
      type: String,
      required: true,
    },
    selectedIssues: {
      type: Array,
      required: true,
    },
    copies: {
      type: Array,
      required: true,
    },
  }),
  emit = defineEmits([
    "update-issues",
    "create-purchase",
    "delete-purchase",
    "close",
  ]),
  { conditions } = condition();

let defaultState = $ref({
    condition: "do_not_change",
    isToSell: "do_not_change",
    purchaseId: "do_not_change",
  }),
  today = new Date().toISOString().slice(0, 10),
  { t: $t } = useI18n(),
  newPurchaseDescription = $ref(""),
  newPurchaseDate = $ref(today),
  editingCopies = $ref([]),
  currentCopyIndex = $ref(0),
  purchases = $computed(() => collection().purchases),
  conditionStates = $computed(() => ({
    ...(isSingleIssueSelected
      ? {}
      : {
          do_not_change: $t("Conserver l'état actuel"),
        }),
    missing: $t("Marquer comme non-possédé(s)"),
    possessed: $t("Marquer comme possédé(s)"),
    bad: $t("Marquer comme en mauvais état"),
    notsogood: $t("Marquer comme en état moyen"),
    good: $t("Marquer comme en bon état"),
  })),
  purchaseStates = $computed(() => ({
    ...(isSingleIssueSelected
      ? {}
      : {
          do_not_change: $t("Conserver la date d'achat"),
        }),
    link: $t("Associer avec une date d'achat"),
    unlink: $t("Désassocier de la date d'achat"),
  })),
  isSingleIssueSelected = $computed(() => selectedIssues.length === 1),
  hasNoCopies = $computed(() => !editingCopies.length),
  hasMaxCopies = $computed(() => editingCopies.length >= 3),
  r = l10n().r,
  formatDate = (value) => (/\d{4}-\d{2}-\d{2}/.test(value) ? value : today),
  updateEditingCopies = () => {
    if (selectedIssues.length === 1) {
      if (copies.length) {
        editingCopies = JSON.parse(JSON.stringify(copies));
      } else {
        editingCopies = [{ ...defaultState, condition: "missing" }];
      }
    } else {
      editingCopies = [{ ...defaultState }];
    }
  },
  convertConditionToDbValue = (condition) =>
    (conditions.find(({ value }) => value === condition) || { dbValue: null })
      .dbValue,
  updateSelectedIssues = async () => {
    let issueDetails = {
      condition: editingCopies.map(({ condition }) =>
        convertConditionToDbValue(condition)
      ),
      istosell: editingCopies.map(({ isToSell }) => isToSell),
      purchaseId: editingCopies.map(({ purchaseId }) => purchaseId),
    };
    if (!isSingleIssueSelected) {
      issueDetails = Object.keys(issueDetails).reduce(
        (acc, detailKey) => ({
          ...acc,
          [detailKey]: issueDetails[detailKey][0],
        }),
        {}
      );
    }

    emit("update-issues", {
      publicationCode: publicationcode,
      issueNumbers: selectedIssues,
      ...issueDetails,
    });
  },
  createPurchaseDate = async () =>
    emit("create-purchase", {
      date: newPurchaseDate,
      description: newPurchaseDescription,
    });

watch(
  () => selectedIssues,
  () => updateEditingCopies(),
  { immediate: true }
);
watch(
  () => copies,
  () => updateEditingCopies(),
  { immediate: true }
);
</script>

<style lang="scss">
.v-contextmenu-inner {
  &,
  li,
  .v-contextmenu-group__menus {
    padding: 0 !important;
  }

  :deep(.copies-tabs) {
    position: initial;
    display: flex;
    padding-bottom: 0;
    padding-top: 0;
  }

  .nav-item:not(.disabled) .nav-link {
    color: #212529 !important;
    cursor: pointer;
  }

  li {
    &.disabled {
      a {
        background: initial;
        border: initial;
        color: inherit;
        cursor: not-allowed;
      }
    }

    &.clickable:hover {
      background-color: #4f5b69 !important;
      color: #fff;
      cursor: pointer;
    }

    &.header,
    &.clone,
    &.footer {
      height: 30px;
      line-height: 25px;
      font-size: 14px;
      background-color: #3d4b5f;
      color: white;
      padding: 2px;
      font-weight: bold;
      text-align: center;

      &.clone {
        background-color: #308290;
        cursor: pointer;

        &.disabled:hover {
          cursor: default;
        }
      }

      &.footer {
        background-color: green;
        border-top: 3px solid #e6e6e6;
      }
    }

    &.menu-separator {
      color: black;
      font-size: 12px;
      font-weight: bold;
      line-height: 20px;
      text-align: center;
      border: 1px solid #e6e6e6;
      border-top-width: 3px;
      padding: 0.2em;
    }

    .v-contextmenu-item {
      display: flex;
      align-items: center;
      color: black;
      line-height: 25px;
      background-position: left center;
      padding: 0 12px !important;

      &.selected {
        background-color: #a52a2a;
        color: white;
      }

      &.purchase-state {
        &.link {
          &:after {
            position: absolute;
            font-weight: bold;
            right: 10px;
            content: ">";
          }
        }
      }

      &.purchase-date {
        justify-content: space-between;
        background-repeat: no-repeat;
        background-size: 12px;
        background-position-x: 10px;
        line-height: 25px;

        .date {
          width: 70px;
        }
      }

      :deep(.issue-condition) {
        margin-right: 8px;
      }

      > svg {
        margin-right: 8px;
        font-size: 16px;
      }
    }
  }
}
</style>
