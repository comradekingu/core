<template>
  <ion-page>
    <ion-item>
      <ion-label>{{ t('condition') }}</ion-label>

      <ion-radio-group v-if="selectedCondition" :model-value="selectedCondition">
        <ion-radio
          v-for="condition of conditions"
          :key="condition"
          :class="`dm-condition-background ${condition}`"
          :value="condition"
          :aria-label="t(`condition_${condition}`)"
        />
      </ion-radio-group>
    </ion-item>
    <ion-item>
      <ion-label>{{ t('in_to_read_list') }}</ion-label>
      <ion-checkbox slot="end" v-model="issue.inToReadList" :aria-label="t('in_to_read_list')" /> </ion-item
    ><ion-item>
      <ion-label>{{ t('purchase_date') }}</ion-label>
      <ion-list>
        <ion-button>{{ t('create_new_purchase_date') }}</ion-button>
        <ion-radio-group :model-value="issue.purchaseId" :value="issue.purchaseId" class="vertical">
          <ion-list>
            <ion-item>
              <ion-radio :value="null" :aria-label="t('no_purchase_date')" />
              <div>
                <ion-label>{{ t('no_purchase_date') }}</ion-label>
              </div>
            </ion-item>
            <ion-item v-for="purchase of purchases">
              <ion-radio :value="purchase.id" :aria-label="purchase.description" />
              <div>
                <ion-label>{{ purchase.date }}</ion-label>
                <ion-label>{{ purchase.description }}</ion-label>
              </div>
            </ion-item>
          </ion-list>
        </ion-radio-group>
      </ion-list>
    </ion-item>
  </ion-page>
</template>
<script setup lang="ts">
import type { Issue } from '~/persistence/models/dm/Issue';
import type { purchaseWithStringDate } from '~/stores/collection';
import { collection } from '~/stores/collection';
import { condition } from '~/stores/condition';

const { t } = useI18n();
const route = useRoute();

const conditionStore = condition();
const collectionStore = collection();

const purchases = computed(() => collectionStore.purchases);
const conditions = computed(() => ['missing', ...Object.values(conditionStore.conditionL10n.map(({ en }) => en))]);

const publicationcode = computed(() => `${route.params.countrycode}/${route.params.magazinecode}`);
const issuecode = computed(() => `${publicationcode.value} ${route.params.issuenumber}`);
const copyIndex = computed(() => parseInt(route.params.copyIndex as string) as number);
const issue = computed(
  () =>
    collectionStore.issuesByIssueCode?.[issuecode.value!]?.[copyIndex.value!] ||
    ({
      purchaseId: null,
    } as Issue),
);

const selectedCondition = ref(null as string | null);
const selectedPurchase = ref(null as purchaseWithStringDate | null);

watch(
  () => issue.value,
  (newIssue) => {
    selectedPurchase.value = newIssue?.purchase;
    const newCondition = newIssue?.condition;
    selectedCondition.value = newCondition
      ? conditionStore.conditionL10n.find(({ fr }) => fr === newCondition)?.en || 'none'
      : 'none';
  },
  { immediate: true },
);

collectionStore.loadCollection();
collectionStore.loadPurchases();
</script>

<style scoped lang="scss">
ion-radio::part(container) {
  width: 30px;
  height: 30px;

  border-radius: 16px;
  border: 2px solid #ddd;
}

ion-radio {
  &::part(mark) {
    width: 100%;
    height: 100%;
  }
}

ion-radio-group {
  display: flex;

  &.vertical {
    flex-direction: column;
  }
}
</style>
