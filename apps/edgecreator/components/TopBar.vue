<template>
  <b-container fluid>
    <b-row align="center" class="pt-2">
      <b-col class="text-left">
        <b-button v-b-toggle.sidebar>Toggle Options</b-button>
        <b-sidebar id="sidebar" v-model="showSidebar" title="Options" shadow>
          <b-container class="px-3 py-2">
            <b-row align-items="center">
              <b-col cols="6">
                Zoom
              </b-col>
              <b-col cols="2">{{ zoom }} </b-col>
              <b-col cols="4">
                <input v-model="zoom" type="range" min="1" max="8" step="0.5" style="width: 100%;"
              /></b-col>
            </b-row>
            <b-row>
              <b-col><label for="showIssueNumbers">Show issue numbers</label></b-col>
              <b-col> <b-checkbox id="showIssueNumbers" v-model="showIssueNumbers" /></b-col>
            </b-row>
            <b-row>
              <b-col><label for="showPreviousEdge">Show previous edge</label></b-col>
              <b-col>
                <b-checkbox
                  id="showPreviousEdge"
                  v-model="showPreviousEdge"
                  :disabled="!edgesBefore.length"
              /></b-col>
            </b-row>
            <b-row>
              <b-col><label for="showNextEdge">Show next edge</label></b-col>
              <b-col>
                <b-checkbox id="showNextEdge" v-model="showNextEdge" :disabled="!edgesAfter.length"
              /></b-col> </b-row
          ></b-container>
        </b-sidebar>
      </b-col>
      <b-col align-self="center" class="col-sm-4">
        <b-button to="/"><b-icon-house /> Home</b-button>
      </b-col>
      <b-col />
    </b-row>
    <b-row align="center" class="p-2">
      <b-col align-self="center">
        <b-button
          v-b-tooltip.hover
          v-b-toggle.collapse-dimensions
          title="Change dimensions"
          pill
          size="sm"
          variant="outline-primary"
          ><b-icon-arrows-angle-expand
        /></b-button>
        <b-collapse id="collapse-dimensions" class="mt-2">
          <b-card class="mb-2" style="max-width: 12rem;">
            <b-row>
              <b-col sm="6">
                <label for="width">Width</label>
              </b-col>
              <b-col sm="6">
                <b-form-input
                  id="width"
                  :value="width"
                  size="sm"
                  autocomplete="off"
                  type="number"
                  @input="setDimensions({ width: $event, height })"
                ></b-form-input>
              </b-col>
            </b-row>
            <b-row>
              <b-col sm="6">
                <label for="height">Height</label>
              </b-col>
              <b-col sm="6">
                <b-form-input
                  id="width"
                  :value="height"
                  size="sm"
                  autocomplete="off"
                  type="number"
                  @input="setDimensions({ width, height: $event })"
                ></b-form-input>
              </b-col>
            </b-row>
          </b-card>
        </b-collapse>
        <b-button
          v-b-tooltip.hover
          title="Lock"
          pill
          :variant="locked ? 'primary' : 'outline-primary'"
          :disabled="issuenumbers.length === 1"
          size="sm"
          @click="locked = !locked"
          ><b-icon-lock v-if="locked" /><b-icon-unlock v-else
        /></b-button>
        <b-button
          v-b-tooltip.hover
          title="Edge photo"
          pill
          variant="outline-primary"
          :disabled="issuenumbers.length > 1"
          size="sm"
          @click="showPhotoModal = !showPhotoModal"
          ><b-icon-camera /><b-modal ok-only :visible="showPhotoModal"
            ><upload
              photo
              :edge="{
                country,
                magazine,
                issuenumber: issuenumbers[0],
              }" /></b-modal
        ></b-button>
        <b-button
          v-b-tooltip.hover
          title="Export"
          pill
          variant="outline-success"
          size="sm"
          @click="exportSvg"
          ><b-icon-archive
        /></b-button>
      </b-col>
    </b-row>
    <b-row align="center" class="pb-2" style="border-bottom: 1px solid grey;">
      <b-col align-self="center">
        <img :src="flagImageUrl" :alt="country" />&nbsp;{{ magazine }}&nbsp;{{ issuenumbers[0]
        }}<span v-if="issuenumbers.length > 1">
          to {{ issuenumbers[issuenumbers.length - 1] }}</span
        >
      </b-col>
    </b-row>
  </b-container>
</template>
<script>
import { mapState, mapMutations } from 'vuex'
import {
  BIconArchive,
  BIconArrowsAngleExpand,
  BIconCamera,
  BIconHouse,
  BIconLock,
  BIconUnlock,
} from 'bootstrap-vue'
import Upload from '~/components/Upload'

export default {
  name: 'TopBar',
  components: {
    Upload,
    BIconArchive,
    BIconArrowsAngleExpand,
    BIconCamera,
    BIconHouse,
    BIconLock,
    BIconUnlock,
  },
  data() {
    return {
      showSidebar: true,
      showPhotoModal: false,
    }
  },
  computed: {
    locked: {
      get() {
        return this.$store.state.ui.locked
      },
      set(value) {
        this.$store.commit('ui/setLocked', value)
      },
    },
    zoom: {
      get() {
        return this.$store.state.zoom
      },
      set(value) {
        this.$store.commit('setZoom', value)
      },
    },
    showIssueNumbers: {
      get() {
        return this.$store.state.ui.showIssueNumbers
      },
      set(value) {
        this.$store.commit('ui/setShowIssueNumbers', value)
      },
    },
    showPreviousEdge: {
      get() {
        return this.$store.state.ui.showPreviousEdge
      },
      set(value) {
        this.$store.commit('ui/setShowPreviousEdge', value)
      },
    },
    showNextEdge: {
      get() {
        return this.$store.state.ui.showNextEdge
      },
      set(value) {
        this.$store.commit('ui/setShowNextEdge', value)
      },
    },
    flagImageUrl() {
      return `${process.env.DM_URL}/images/flags/${this.country}.png`
    },
    ...mapState([
      'width',
      'height',
      'country',
      'magazine',
      'issuenumbers',
      'edgesBefore',
      'edgesAfter',
    ]),
  },
  methods: {
    getEdgeCanvasRefId(issuenumber) {
      return `edge-canvas-${issuenumber}`
    },
    exportSvg() {
      const vm = this
      this.zoom = 1.5
      vm.$nextTick().then(() => {
        vm.issuenumbers.forEach((issuenumber) => {
          vm.$axios
            .$put('/fs/export', {
              country: vm.country,
              magazine: vm.magazine,
              issuenumber,
              content: document.getElementById(vm.getEdgeCanvasRefId(issuenumber)).outerHTML,
            })
            .then(() => {
              vm.$bvToast.toast('Export done', {
                toaster: 'b-toaster-top-center',
              })
            })
        })
      })
    },
    ...mapMutations(['setDimensions']),
  },
}
</script>

<style scoped></style>
