<template>
  <b-container fluid>
    <b-row align="center" class="pt-2">
      <b-col class="text-left">
        <b-button v-b-toggle.sidebar>Toggle Options</b-button>
        <b-sidebar id="sidebar" v-model="showSidebar" title="Options" shadow>
          <b-container class="px-3 py-2">
            <b-row align-items="center">
              <b-col cols="6">
                Zoom
              </b-col>
              <b-col cols="2">{{ zoom }} </b-col>
              <b-col cols="4">
                <input v-model="zoom" type="range" min="1" max="8" step="0.5" style="width: 100%;"
              /></b-col>
            </b-row>
            <b-row>
              <b-col><label for="showIssueNumbers">Show issue numbers</label></b-col>
              <b-col> <b-checkbox id="showIssueNumbers" v-model="showIssueNumbers" /></b-col>
            </b-row>
            <b-row>
              <b-col><label for="showPreviousEdge">Show previous edge</label></b-col>
              <b-col>
                <b-checkbox
                  id="showPreviousEdge"
                  v-model="showPreviousEdge"
                  :disabled="!edgesBefore.length"
              /></b-col>
            </b-row>
            <b-row>
              <b-col><label for="showNextEdge">Show next edge</label></b-col>
              <b-col>
                <b-checkbox id="showNextEdge" v-model="showNextEdge" :disabled="!edgesAfter.length"
              /></b-col>
            </b-row>
            <b-row>
              <b-col><label for="showEdgePhotos">Show edge photos</label></b-col>
              <b-col>
                <b-checkbox id="showEdgePhotos" v-model="showEdgePhotos" :disabled="!hasPhotoUrl"
              /></b-col> </b-row
          ></b-container>
        </b-sidebar>
      </b-col>
      <b-col align-self="center" class="col-sm-4">
        <b-button to="/"><b-icon-house /> Home</b-button>
      </b-col>
      <b-col />
    </b-row>
    <b-row align="center" class="p-2">
      <b-col align-self="center">
        <b-collapse id="collapse-dimensions" class="mt-2">
          <dimensions :width="width" :height="height" @change="setDimensions" />
        </b-collapse>
        <b-button
          v-b-tooltip.hover
          title="Lock"
          pill
          :variant="locked ? 'primary' : 'outline-primary'"
          :disabled="issuenumbers.length === 1"
          size="sm"
          @click="locked = !locked"
          ><b-icon-lock v-if="locked" /><b-icon-unlock v-else
        /></b-button>
        <b-button
          v-b-tooltip.hover
          title="Edge photo"
          pill
          variant="outline-primary"
          :disabled="issuenumbers.length > 1"
          size="sm"
          @click="showPhotoModal = !showPhotoModal"
          ><b-icon-camera /><b-modal v-model="showPhotoModal" ok-only>
            <Gallery image-type="photos" /> </b-modal
        ></b-button>
        <b-button
          v-b-tooltip.hover
          v-b-toggle.collapse-dimensions
          title="Change dimensions"
          pill
          size="sm"
          variant="outline-primary"
          ><b-icon-arrows-angle-expand /></b-button
        >&nbsp;<b-button
          v-b-tooltip.hover
          title="Clone from another model"
          pill
          size="sm"
          variant="outline-primary"
          @click="showCloneModal = !showCloneModal"
          ><b-icon-custom-duplicate /><b-modal
            v-model="showCloneModal"
            title="Clone from another model"
            ok-only
            ok-title="Clone"
            :ok-disabled="!modelToClone"
            @ok="clone()"
            ><issue-select
              :disable-ongoing-or-published="false"
              disable-not-ongoing-nor-published
              @change="modelToClone = $event" /></b-modal
        ></b-button>

        <div v-if="saveProgress" class="progress-wrapper">
          <b-progress v-b-tooltip.hover :value="saveProgress" :max="100" variant="primary" />
        </div>
        <b-button v-else-if="saveResult === 'success'" pill variant="outline-primary" size="sm">
          <b-icon-check />
        </b-button>
        <b-button v-else-if="saveResult === 'error'" pill variant="outline-danger" size="sm">
          <b-icon-x />
        </b-button>
        <b-button
          v-else
          v-b-tooltip.hover
          title="Save"
          pill
          variant="outline-primary"
          size="sm"
          @click="save(false)"
          ><b-icon-archive
        /></b-button>

        <div v-if="exportProgress" class="progress-wrapper">
          <b-progress v-b-tooltip.hover :value="exportProgress" :max="100" variant="success" />
        </div>
        <b-button v-else-if="exportResult === 'success'" pill variant="outline-success" size="sm">
          <b-icon-check />
        </b-button>
        <b-button v-else-if="exportResult === 'error'" pill variant="outline-danger" size="sm">
          <b-icon-x />
        </b-button>
        <b-button
          v-else
          v-b-tooltip.hover
          title="Export"
          pill
          variant="outline-success"
          size="sm"
          @click="showExportModal = !showExportModal"
          ><b-icon-cloud-arrow-up-fill /><b-modal
            v-model="showExportModal"
            title="Export"
            ok-only
            ok-title="Export"
            @ok="save(true)"
          >
            <div v-for="contributionType in ['photographers', 'designers']" :key="contributionType">
              <h2>{{ $t(`export.${contributionType}`) }}</h2>
              <vue-bootstrap-typeahead
                :ref="`${contributionType}-typeahead`"
                :data="allUsers.filter((user) => !isContributor(user, contributionType))"
                :serializer="(u) => u.username"
                :placeholder="$t('export.typeahead.placeholder')"
                :min-matching-chars="0"
                @hit="
                  addContributorAllIssues($event, contributionType)
                  $refs[`${contributionType}-typeahead`][0].inputValue = ''
                "
              />
              <ul>
                <li v-for="user in getContributors(contributionType)" :key="user.username">
                  {{ user.username }}
                  <b-icon-x-square-fill
                    style="cursor: pointer;"
                    @click="
                      removeContributor({
                        contributionType: contributionType,
                        userToRemove: user,
                      })
                    "
                  />
                </li>
              </ul></div></b-modal
        ></b-button>
      </b-col>
    </b-row>
    <b-row align="center" class="pb-2" style="border-bottom: 1px solid grey;">
      <b-col align-self="center">
        <img :src="flagImageUrl" :alt="country" />&nbsp;{{ magazine }}&nbsp;{{ issuenumbers[0]
        }}<span v-if="issuenumbers.length > 1">
          to {{ issuenumbers[issuenumbers.length - 1] }}</span
        >
      </b-col>
    </b-row>
  </b-container>
</template>
<script>
import { mapMutations, mapState } from 'vuex'
import {
  BIconArchive,
  BIconArrowsAngleExpand,
  BIconCamera,
  BIconHouse,
  BIconLock,
  BIconXSquareFill,
  BIconX,
  BIconCheck,
  BIconUnlock,
  BIconCloudArrowUpFill,
} from 'bootstrap-vue'
import Dimensions from '@/components/Dimensions'
import Gallery from '@/components/Gallery'
import BIconCustomDuplicate from '@/components/BIconCustomDuplicate'
import IssueSelect from '@/components/IssueSelect'

export default {
  name: 'TopBar',
  components: {
    IssueSelect,
    Gallery,
    Dimensions,
    BIconArchive,
    BIconCloudArrowUpFill,
    BIconXSquareFill,
    BIconX,
    BIconArrowsAngleExpand,
    BIconCamera,
    BIconHouse,
    BIconLock,
    BIconCheck,
    BIconUnlock,
    BIconCustomDuplicate,
  },
  data() {
    return {
      showSidebar: true,
      showPhotoModal: false,
      showUploadPhotoModal: false,

      showCloneModal: false,
      modelToClone: null,

      showExportModal: false,
      users: [],
      saveProgress: 0,
      saveResult: null,
      exportProgress: 0,
      exportResult: false,
    }
  },
  computed: {
    locked: {
      get() {
        return this.$store.state.ui.locked
      },
      set(value) {
        this.$store.commit('ui/setLocked', value)
      },
    },
    zoom: {
      get() {
        return this.$store.state.ui.zoom
      },
      set(value) {
        this.$store.commit('ui/setZoom', value)
      },
    },
    showIssueNumbers: {
      get() {
        return this.$store.state.ui.showIssueNumbers
      },
      set(value) {
        this.$store.commit('ui/setShowIssueNumbers', value)
      },
    },
    showPreviousEdge: {
      get() {
        return this.$store.state.ui.showPreviousEdge && this.$store.state.edgesBefore.length
      },
      set(value) {
        this.$store.commit('ui/setShowPreviousEdge', value)
      },
    },
    showNextEdge: {
      get() {
        return this.$store.state.ui.showNextEdge && this.$store.state.edgesAfter.length
      },
      set(value) {
        this.$store.commit('ui/setShowNextEdge', value)
      },
    },
    showEdgePhotos: {
      get() {
        return this.$store.state.ui.showEdgePhotos
      },
      set(value) {
        this.$store.commit('ui/setShowEdgePhotos', value)
      },
    },
    hasPhotoUrl() {
      return Object.keys(this.photoUrls).length
    },
    flagImageUrl() {
      return `${process.env.DM_URL}/images/flags/${this.country}.png`
    },
    ...mapState([
      'width',
      'height',
      'country',
      'magazine',
      'issuenumbers',
      'edgesBefore',
      'edgesAfter',
      'photoUrls',
      'contributors',
    ]),
    ...mapState('user', ['allUsers']),
  },
  watch: {
    saveProgress(newValue) {
      const vm = this
      if (newValue === 100) {
        window.setTimeout(() => {
          vm.saveProgress = 0
          vm.saveResult = 'success'
          window.setTimeout(() => {
            vm.saveResult = null
          }, 2000)
        }, 1000)
      }
    },
    exportProgress(newValue) {
      const vm = this
      if (newValue === 100) {
        window.setTimeout(() => {
          vm.exportProgress = 0
          vm.exportResult = 'success'
          window.setTimeout(() => {
            vm.exportResult = null
          }, 2000)
        }, 1000)
      }
    },
  },
  methods: {
    getContributors(contributionType) {
      const vm = this
      return this.allUsers.filter((user) => vm.isContributor(user, contributionType))
    },
    isContributor(user, contributionType) {
      const vm = this
      return Object.keys(this.contributors).reduce((acc, issueNumber) => {
        return acc || vm.contributors[issueNumber][contributionType].includes(user)
      }, false)
    },
    addContributorAllIssues(user, contributionType) {
      const vm = this
      this.issuenumbers.forEach((issuenumber) => {
        vm.addContributor({ issuenumber, contributionType, user })
      })
    },
    removeVueMarkup(element) {
      Object.values(element.attributes || {})
        .filter((attribute) => attribute.name.startsWith('data-v-'))
        .forEach(({ name: attributeName }) => {
          element.removeAttribute(attributeName)
        })
      Object.values(element.childNodes).forEach((childNode) => {
        this.removeVueMarkup(childNode)
      })
      return element
    },
    async clone() {
      const { publicationCode, issueNumber } = this.modelToClone
      for (const targetIssuenumber of this.issuenumbers) {
        this.$emit('overwrite-model', { publicationCode, issueNumber, targetIssuenumber })
      }
    },
    save(runExport) {
      const vm = this
      this.zoom = 1.5
      vm.$nextTick().then(() => {
        vm.issuenumbers.forEach(async (issuenumber) => {
          const cleanSvg = vm.removeVueMarkup(
            document.getElementById(`edge-canvas-${issuenumber}`).cloneNode(true)
          )
          const response = await vm.$axios.$put('/fs/save', {
            runExport,
            country: vm.country,
            magazine: vm.magazine,
            issuenumber,
            ...vm.contributors[issuenumber],
            content: cleanSvg.outerHTML,
          })
          const isSuccess = response && response.svgPath
          if (isSuccess) {
            if (runExport) {
              vm.exportProgress = parseInt(vm.exportProgress + 100 / vm.issuenumbers.length)
            } else {
              vm.saveProgress = parseInt(vm.saveProgress + 100 / vm.issuenumbers.length)
            }
          } else if (runExport) {
            vm.exportProgress = 0
            vm.exportResult = 'error'
          } else {
            vm.saveProgress = 0
            vm.saveResult = 'error'
          }
        })
      })
    },
    ...mapMutations(['setDimensions', 'addContributor', 'removeContributor', 'setPhotoUrl']),
  },
}
</script>
<style>
.b-icon {
  vertical-align: middle !important;
  height: 15px;
}
.progress-wrapper {
  display: inline-block;
  vertical-align: middle;
  width: 2rem;
}
</style>
